/**
 * AgroFocus - Inspe√ß√µes Routes (PostgreSQL)
 * Workflow de inspe√ß√µes para an√°lise por especialista
 */

const express = require('express');
const router = express.Router();
const { Inspecao, Ocorrencia } = require('../models/db.models');
const { authMiddleware, getPermissaoFazenda, PERMISSOES } = require('./auth.routes');

// Criar nova inspe√ß√£o pendente de an√°lise do especialista
router.post('/pendentes', authMiddleware, async (req, res) => {
  try {
    const {
      fotos, cultura, talhao_id, talhao_nome, fazenda_id, fazenda_nome,
      latitude, longitude, operador_nome, observacoes
    } = req.body;

    if (!fotos || fotos.length === 0) {
      return res.status(400).json({
        sucesso: false,
        erro: 'Pelo menos uma foto √© obrigat√≥ria'
      });
    }

    // Verificar permiss√£o na fazenda
    if (fazenda_id) {
      const permissao = await getPermissaoFazenda(req.usuario.id, fazenda_id);
      if (!permissao) {
        return res.status(403).json({ sucesso: false, erro: 'Acesso negado √† fazenda' });
      }
    }

    const inspecao = await Inspecao.create({
      fotos,
      cultura: cultura || 'N√£o especificada',
      talhao_id,
      talhao_nome: talhao_nome || 'N√£o especificado',
      fazenda_id,
      fazenda_nome: fazenda_nome || 'N√£o especificado',
      latitude,
      longitude,
      operador_id: req.usuario.id,
      operador_nome: operador_nome || req.usuario.nome || 'Operador',
      observacoes: observacoes || ''
    });

    // Log de notifica√ß√£o para o especialista
    console.log('\nüîî =========================================');
    console.log('üîî NOVA INSPE√á√ÉO PENDENTE DE AN√ÅLISE');
    console.log('üîî =========================================');
    console.log(`üÜî ID: ${inspecao.id}`);
    console.log(`üå± Cultura: ${inspecao.cultura}`);
    console.log(`üè° Fazenda: ${inspecao.fazenda_nome}`);
    console.log(`üìç Talh√£o: ${inspecao.talhao_nome}`);
    console.log(`üë§ Operador: ${inspecao.operador_nome}`);
    console.log(`üì∏ Fotos: ${fotos.length}`);
    console.log(`üìÖ Data: ${new Date().toLocaleString('pt-BR')}`);
    console.log('üîî =========================================\n');

    res.status(201).json({
      sucesso: true,
      inspecao: {
        id: inspecao.id,
        status: inspecao.status,
        talhao_nome: inspecao.talhao_nome,
        fazenda_nome: inspecao.fazenda_nome,
        mensagem: 'Inspe√ß√£o registrada e aguardando an√°lise do especialista'
      },
      notificacao: {
        mensagem: `üÜï Nova inspe√ß√£o pendente: ${inspecao.cultura} em ${inspecao.talhao_nome}`,
        foto_url: inspecao.fotos[0]
      }
    });

  } catch (err) {
    console.error('Erro ao criar inspe√ß√£o pendente:', err);
    res.status(500).json({
      sucesso: false,
      erro: 'Erro ao registrar inspe√ß√£o: ' + err.message
    });
  }
});

// Listar inspe√ß√µes pendentes (para o especialista)
router.get('/pendentes', authMiddleware, async (req, res) => {
  try {
    // Verificar se usu√°rio √© gerente ou admin
    if (req.usuario.perfil !== 'gerente' && req.usuario.perfil !== 'admin') {
      return res.status(403).json({ 
        sucesso: false, 
        erro: 'Acesso restrito a gerentes e administradores' 
      });
    }

    const pendentes = await Inspecao.findPendentes();

    res.json({
      sucesso: true,
      total: pendentes.length,
      inspecoes: pendentes.map(i => ({
        id: i.id,
        cultura: i.cultura,
        talhao_nome: i.talhao_nome || i.talhao_nome_real,
        fazenda_nome: i.fazenda_nome || i.fazenda_nome_real,
        operador_nome: i.operador_nome,
        data_criacao: i.data_criacao,
        foto_preview: i.fotos[0],
        observacoes: i.observacoes
      }))
    });

  } catch (err) {
    console.error('Erro ao listar inspe√ß√µes pendentes:', err);
    res.status(500).json({
      sucesso: false,
      erro: err.message
    });
  }
});

// Obter detalhes de uma inspe√ß√£o pendente
router.get('/pendentes/:id', authMiddleware, async (req, res) => {
  try {
    // Verificar se usu√°rio √© gerente ou admin
    if (req.usuario.perfil !== 'gerente' && req.usuario.perfil !== 'admin') {
      return res.status(403).json({ 
        sucesso: false, 
        erro: 'Acesso restrito a gerentes e administradores' 
      });
    }

    const inspecao = await Inspecao.findById(req.params.id);
    
    if (!inspecao) {
      return res.status(404).json({
        sucesso: false,
        erro: 'Inspe√ß√£o n√£o encontrada'
      });
    }

    res.json({
      sucesso: true,
      inspecao
    });

  } catch (err) {
    console.error('Erro ao buscar inspe√ß√£o:', err);
    res.status(500).json({
      sucesso: false,
      erro: err.message
    });
  }
});

// Submeter an√°lise do especialista
router.post('/pendentes/:id/analisar', authMiddleware, async (req, res) => {
  try {
    // Verificar se usu√°rio √© gerente ou admin
    if (req.usuario.perfil !== 'gerente' && req.usuario.perfil !== 'admin') {
      return res.status(403).json({ 
        sucesso: false, 
        erro: 'Acesso restrito a gerentes e administradores' 
      });
    }

    const inspecao = await Inspecao.findById(req.params.id);
    
    if (!inspecao) {
      return res.status(404).json({
        sucesso: false,
        erro: 'Inspe√ß√£o n√£o encontrada'
      });
    }

    const {
      tipo, categoria, severidade, confianca, descricao, recomendacao,
      sintomas, estagio, danos, produtosSugeridos, prazoAcao, observacoesEspecialista
    } = req.body;

    // Validar campos obrigat√≥rios
    if (!tipo || !categoria || !descricao) {
      return res.status(400).json({
        sucesso: false,
        erro: 'Tipo, categoria e descri√ß√£o s√£o obrigat√≥rios'
      });
    }

    // Atualizar inspe√ß√£o com an√°lise
    const inspecaoAtualizada = await Inspecao.analisar(req.params.id, {
      tipo,
      categoria,
      severidade: severidade || 'media',
      confianca: confianca || 0.95,
      descricao,
      recomendacao: recomendacao || '',
      sintomas: sintomas || [],
      estagio: estagio || 'N√£o especificado',
      danos: danos || 'N√£o especificado',
      produtosSugeridos: produtosSugeridos || [],
      prazoAcao: prazoAcao || 'Monitorar',
      observacoesEspecialista: observacoesEspecialista || ''
    });

    // Criar ocorr√™ncia automaticamente a partir da inspe√ß√£o analisada
    try {
      await Ocorrencia.create({
        tipo,
        categoria,
        titulo: `Inspe√ß√£o: ${tipo}`,
        descricao,
        severidade,
        status: 'aberta',
        talhao_id: inspecao.talhao_id,
        fazenda_id: inspecao.fazenda_id,
        talhao_nome: inspecao.talhao_nome,
        fazenda_nome: inspecao.fazenda_nome,
        operador_id: inspecao.operador_id,
        operador_nome: inspecao.operador_nome,
        latitude: inspecao.latitude,
        longitude: inspecao.longitude,
        metodo_analise: 'especialista',
        ia_analise: tipo,
        ia_confianca: confianca,
        foto_url_1: inspecao.fotos[0],
        foto_url_2: inspecao.fotos[1] || null,
        foto_url_3: inspecao.fotos[2] || null
      });
    } catch (ocorrenciaErr) {
      console.error('Erro ao criar ocorr√™ncia da inspe√ß√£o:', ocorrenciaErr);
      // N√£o falhar se n√£o conseguir criar a ocorr√™ncia
    }

    console.log('\n‚úÖ =========================================');
    console.log('‚úÖ INSPE√á√ÉO ANALISADA PELO ESPECIALISTA');
    console.log('‚úÖ =========================================');
    console.log(`üÜî ID: ${inspecao.id}`);
    console.log(`üå± Diagn√≥stico: ${tipo}`);
    console.log(`üìä Severidade: ${severidade}`);
    console.log(`‚úÖ =========================================\n');

    res.json({
      sucesso: true,
      mensagem: 'An√°lise registrada com sucesso',
      inspecao: {
        id: inspecaoAtualizada.id,
        status: inspecaoAtualizada.status,
        analise: {
          tipo: inspecaoAtualizada.analise_tipo,
          categoria: inspecaoAtualizada.analise_categoria,
          severidade: inspecaoAtualizada.analise_severidade,
          descricao: inspecaoAtualizada.analise_descricao,
          recomendacao: inspecaoAtualizada.analise_recomendacao
        }
      }
    });

  } catch (err) {
    console.error('Erro ao analisar inspe√ß√£o:', err);
    res.status(500).json({
      sucesso: false,
      erro: err.message
    });
  }
});

// Verificar status de uma inspe√ß√£o (para o operador consultar)
router.get('/:id/status', authMiddleware, async (req, res) => {
  try {
    const inspecao = await Inspecao.findById(req.params.id);
    
    if (!inspecao) {
      return res.status(404).json({
        sucesso: false,
        erro: 'Inspe√ß√£o n√£o encontrada'
      });
    }

    // Verificar se o usu√°rio tem permiss√£o (dono da inspe√ß√£o ou gerente)
    if (inspecao.operador_id !== req.usuario.id && 
        req.usuario.perfil !== 'gerente' && 
        req.usuario.perfil !== 'admin') {
      return res.status(403).json({
        sucesso: false,
        erro: 'Acesso negado'
      });
    }

    res.json({
      sucesso: true,
      id: inspecao.id,
      status: inspecao.status,
      data_criacao: inspecao.data_criacao,
      data_analise: inspecao.data_analise,
      analise: inspecao.status === 'analisada' ? {
        tipo: inspecao.analise_tipo,
        categoria: inspecao.analise_categoria,
        severidade: inspecao.analise_severidade,
        confianca: inspecao.analise_confianca,
        descricao: inspecao.analise_descricao,
        recomendacao: inspecao.analise_recomendacao,
        sintomas: inspecao.analise_sintomas,
        estagio: inspecao.analise_estagio,
        danos: inspecao.analise_danos,
        produtos_sugeridos: inspecao.analise_produtos_sugeridos,
        prazo_acao: inspecao.analise_prazo_acao,
        observacoes: inspecao.analise_observacoes,
        analista: inspecao.analista_nome
      } : null
    });

  } catch (err) {
    console.error('Erro ao buscar status da inspe√ß√£o:', err);
    res.status(500).json({
      sucesso: false,
      erro: err.message
    });
  }
});

// Rejeitar an√°lise (se a foto n√£o for adequada)
router.post('/pendentes/:id/rejeitar', authMiddleware, async (req, res) => {
  try {
    // Verificar se usu√°rio √© gerente ou admin
    if (req.usuario.perfil !== 'gerente' && req.usuario.perfil !== 'admin') {
      return res.status(403).json({ 
        sucesso: false, 
        erro: 'Acesso restrito a gerentes e administradores' 
      });
    }

    const inspecao = await Inspecao.findById(req.params.id);
    
    if (!inspecao) {
      return res.status(404).json({
        sucesso: false,
        erro: 'Inspe√ß√£o n√£o encontrada'
      });
    }

    const { motivo } = req.body;

    const inspecaoAtualizada = await Inspecao.rejeitar(req.params.id, motivo || 'Foto n√£o adequada para an√°lise');

    res.json({
      sucesso: true,
      mensagem: 'Inspe√ß√£o rejeitada',
      motivo: inspecaoAtualizada.motivo_rejeicao
    });

  } catch (err) {
    console.error('Erro ao rejeitar inspe√ß√£o:', err);
    res.status(500).json({
      sucesso: false,
      erro: err.message
    });
  }
});

// Listar todas as inspe√ß√µes (com filtros)
router.get('/', authMiddleware, async (req, res) => {
  try {
    const { fazenda_id, talhao_id, status } = req.query;
    
    // Verificar permiss√£o se filtrando por fazenda
    if (fazenda_id) {
      const permissao = await getPermissaoFazenda(req.usuario.id, fazenda_id);
      if (!permissao) {
        return res.status(403).json({ sucesso: false, erro: 'Acesso negado √† fazenda' });
      }
    }
    
    const inspecoes = await Inspecao.findAll({ fazenda_id, talhao_id, status });
    
    res.json({
      sucesso: true,
      total: inspecoes.length,
      inspecoes
    });
  } catch (err) {
    console.error('Erro ao listar inspe√ß√µes:', err);
    res.status(500).json({ sucesso: false, erro: 'Erro interno do servidor' });
  }
});

// OBTER uma inspe√ß√£o espec√≠fica
router.get('/:id', authMiddleware, async (req, res) => {
  try {
    const inspecao = await Inspecao.findById(req.params.id);
    
    if (!inspecao) {
      return res.status(404).json({ sucesso: false, erro: 'Inspe√ß√£o n√£o encontrada' });
    }
    
    // Verificar permiss√£o
    if (inspecao.fazenda_id) {
      const permissao = await getPermissaoFazenda(req.usuario.id, inspecao.fazenda_id);
      if (!permissao && inspecao.operador_id !== req.usuario.id) {
        return res.status(403).json({ sucesso: false, erro: 'Acesso negado' });
      }
    }
    
    res.json({ sucesso: true, inspecao });
  } catch (err) {
    console.error('Erro ao buscar inspe√ß√£o:', err);
    res.status(500).json({ sucesso: false, erro: 'Erro interno do servidor' });
  }
});

module.exports = router;
